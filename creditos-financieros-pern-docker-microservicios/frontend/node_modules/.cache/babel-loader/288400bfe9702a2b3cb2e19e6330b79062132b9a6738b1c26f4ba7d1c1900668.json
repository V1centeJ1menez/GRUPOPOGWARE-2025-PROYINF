{"ast":null,"code":"// controllers/simulacionController.js\nconst Simulacion = require(\"../models/Simulacion\");\nconst {\n  pool\n} = require(\"../db\");\nconst CONFIG = {\n  TASA_BASE_ANUAL: 0.18,\n  GASTOS_OPERACIONALES_PORCENTAJE: 0.02,\n  SEGURO_DESGRAVAMEN_MENSUAL: 0.0012,\n  COMISION_APERTURA: 0.015,\n  MONTO_MINIMO: 500000,\n  MONTO_MAXIMO: 10000000,\n  PLAZO_MINIMO: 6,\n  PLAZO_MAXIMO: 48\n};\n\n/**\n * Calcula los valores financieros del crédito.\n */\nfunction calcularSimulacion(monto, plazo) {\n  const tasaMensual = CONFIG.TASA_BASE_ANUAL / 12;\n  const gastosOperacionales = Math.round(monto * CONFIG.GASTOS_OPERACIONALES_PORCENTAJE);\n  const comisionApertura = Math.round(monto * CONFIG.COMISION_APERTURA);\n  const seguroMensual = Math.round(monto * CONFIG.SEGURO_DESGRAVAMEN_MENSUAL);\n  const montoLiquido = Math.round(monto - gastosOperacionales - comisionApertura);\n\n  // Cuota mensual (sistema francés)\n  const cuotaSinSeguro = monto * tasaMensual / (1 - Math.pow(1 + tasaMensual, -plazo));\n  const cuotaMensual = Math.round(cuotaSinSeguro + seguroMensual);\n  const montoTotal = Math.round(cuotaMensual * plazo);\n  const interesesTotales = Math.round(montoTotal - monto);\n  const cae = parseFloat((CONFIG.TASA_BASE_ANUAL + (gastosOperacionales + comisionApertura) / monto).toFixed(6));\n  const resultado = monto >= CONFIG.MONTO_MINIMO && monto <= CONFIG.MONTO_MAXIMO && plazo >= CONFIG.PLAZO_MINIMO && plazo <= CONFIG.PLAZO_MAXIMO ? \"aprobado\" : \"rechazado\";\n  return {\n    monto,\n    plazo,\n    tasaBase: CONFIG.TASA_BASE_ANUAL,\n    gastosOperacionales,\n    comisionApertura,\n    seguroMensual,\n    montoLiquido,\n    cuotaMensual,\n    montoTotal,\n    interesesTotales,\n    cae,\n    resultado\n  };\n}\n\n/**\n * Crear simulación y guardar en DB\n */\nexports.crearSimulacion = async (req, res) => {\n  try {\n    const {\n      monto,\n      plazo\n    } = req.body;\n    const userId = req.user.id;\n\n    // Validaciones\n    if (!monto || !plazo) return res.status(400).json({\n      error: \"Debe ingresar monto y plazo\"\n    });\n\n    // Calcular simulación\n    const datos = calcularSimulacion(Number(monto), Number(plazo));\n\n    // Guardar en DB\n    const result = await pool.query(`INSERT INTO simulaciones \n        (user_id, monto, plazo, tasa_base, cae, cuota_mensual, monto_total, monto_liquido, gastos_operacionales, comision_apertura, seguro_mensual, resultado)\n       VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12)\n       RETURNING *`, [userId, datos.monto, datos.plazo, datos.tasaBase, datos.cae, datos.cuotaMensual, datos.montoTotal, datos.montoLiquido, datos.gastosOperacionales, datos.comisionApertura, datos.seguroMensual, datos.resultado]);\n    res.status(201).json(result.rows[0]);\n  } catch (error) {\n    console.error(\"Error al crear simulación:\", error);\n    res.status(500).json({\n      error: \"Error al crear simulación\"\n    });\n  }\n};\n\n/**\n * Obtener historial de simulaciones\n */\nexports.obtenerHistorial = async (req, res) => {\n  try {\n    const userId = req.user.id;\n    const limit = req.query.limit ? `LIMIT ${Number(req.query.limit)}` : \"\";\n    const result = await pool.query(`SELECT * FROM simulaciones WHERE user_id = $1 ORDER BY fecha DESC ${limit}`, [userId]);\n    res.json(result.rows);\n  } catch (error) {\n    console.error(\"Error al obtener historial:\", error);\n    res.status(500).json({\n      error: \"Error al obtener historial\"\n    });\n  }\n};\n\n/**\n * Eliminar simulación\n */\nexports.eliminarSimulacion = async (req, res) => {\n  try {\n    const {\n      id\n    } = req.params;\n    const userId = req.user.id;\n    await pool.query(\"DELETE FROM simulaciones WHERE id = $1 AND user_id = $2\", [id, userId]);\n    res.json({\n      message: \"Simulación eliminada\"\n    });\n  } catch (error) {\n    console.error(\"Error al eliminar simulación:\", error);\n    res.status(500).json({\n      error: \"Error al eliminar simulación\"\n    });\n  }\n};","map":{"version":3,"names":["Simulacion","require","pool","CONFIG","TASA_BASE_ANUAL","GASTOS_OPERACIONALES_PORCENTAJE","SEGURO_DESGRAVAMEN_MENSUAL","COMISION_APERTURA","MONTO_MINIMO","MONTO_MAXIMO","PLAZO_MINIMO","PLAZO_MAXIMO","calcularSimulacion","monto","plazo","tasaMensual","gastosOperacionales","Math","round","comisionApertura","seguroMensual","montoLiquido","cuotaSinSeguro","pow","cuotaMensual","montoTotal","interesesTotales","cae","parseFloat","toFixed","resultado","tasaBase","exports","crearSimulacion","req","res","body","userId","user","id","status","json","error","datos","Number","result","query","rows","console","obtenerHistorial","limit","eliminarSimulacion","params","message"],"sources":["/home/numpi/Documentos/Semestre 6/Anal/a/creditos-financieros-pern-docker-microservicios/frontend/src/pages/Simulacion.js"],"sourcesContent":["// controllers/simulacionController.js\nconst Simulacion = require(\"../models/Simulacion\");\nconst { pool } = require(\"../db\");\n\nconst CONFIG = {\n  TASA_BASE_ANUAL: 0.18,\n  GASTOS_OPERACIONALES_PORCENTAJE: 0.02,\n  SEGURO_DESGRAVAMEN_MENSUAL: 0.0012,\n  COMISION_APERTURA: 0.015,\n  MONTO_MINIMO: 500000,\n  MONTO_MAXIMO: 10000000,\n  PLAZO_MINIMO: 6,\n  PLAZO_MAXIMO: 48,\n};\n\n/**\n * Calcula los valores financieros del crédito.\n */\nfunction calcularSimulacion(monto, plazo) {\n  const tasaMensual = CONFIG.TASA_BASE_ANUAL / 12;\n  const gastosOperacionales = Math.round(monto * CONFIG.GASTOS_OPERACIONALES_PORCENTAJE);\n  const comisionApertura = Math.round(monto * CONFIG.COMISION_APERTURA);\n  const seguroMensual = Math.round(monto * CONFIG.SEGURO_DESGRAVAMEN_MENSUAL);\n  const montoLiquido = Math.round(monto - gastosOperacionales - comisionApertura);\n\n  // Cuota mensual (sistema francés)\n  const cuotaSinSeguro = monto * tasaMensual / (1 - Math.pow(1 + tasaMensual, -plazo));\n  const cuotaMensual = Math.round(cuotaSinSeguro + seguroMensual);\n\n  const montoTotal = Math.round(cuotaMensual * plazo);\n  const interesesTotales = Math.round(montoTotal - monto);\n  const cae = parseFloat((CONFIG.TASA_BASE_ANUAL + ((gastosOperacionales + comisionApertura) / monto)).toFixed(6));\n\n  const resultado =\n    monto >= CONFIG.MONTO_MINIMO &&\n    monto <= CONFIG.MONTO_MAXIMO &&\n    plazo >= CONFIG.PLAZO_MINIMO &&\n    plazo <= CONFIG.PLAZO_MAXIMO\n      ? \"aprobado\"\n      : \"rechazado\";\n\n  return {\n    monto,\n    plazo,\n    tasaBase: CONFIG.TASA_BASE_ANUAL,\n    gastosOperacionales,\n    comisionApertura,\n    seguroMensual,\n    montoLiquido,\n    cuotaMensual,\n    montoTotal,\n    interesesTotales,\n    cae,\n    resultado,\n  };\n}\n\n/**\n * Crear simulación y guardar en DB\n */\nexports.crearSimulacion = async (req, res) => {\n  try {\n    const { monto, plazo } = req.body;\n    const userId = req.user.id;\n\n    // Validaciones\n    if (!monto || !plazo)\n      return res.status(400).json({ error: \"Debe ingresar monto y plazo\" });\n\n    // Calcular simulación\n    const datos = calcularSimulacion(Number(monto), Number(plazo));\n\n    // Guardar en DB\n    const result = await pool.query(\n      `INSERT INTO simulaciones \n        (user_id, monto, plazo, tasa_base, cae, cuota_mensual, monto_total, monto_liquido, gastos_operacionales, comision_apertura, seguro_mensual, resultado)\n       VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12)\n       RETURNING *`,\n      [\n        userId,\n        datos.monto,\n        datos.plazo,\n        datos.tasaBase,\n        datos.cae,\n        datos.cuotaMensual,\n        datos.montoTotal,\n        datos.montoLiquido,\n        datos.gastosOperacionales,\n        datos.comisionApertura,\n        datos.seguroMensual,\n        datos.resultado,\n      ]\n    );\n\n    res.status(201).json(result.rows[0]);\n  } catch (error) {\n    console.error(\"Error al crear simulación:\", error);\n    res.status(500).json({ error: \"Error al crear simulación\" });\n  }\n};\n\n/**\n * Obtener historial de simulaciones\n */\nexports.obtenerHistorial = async (req, res) => {\n  try {\n    const userId = req.user.id;\n    const limit = req.query.limit ? `LIMIT ${Number(req.query.limit)}` : \"\";\n\n    const result = await pool.query(\n      `SELECT * FROM simulaciones WHERE user_id = $1 ORDER BY fecha DESC ${limit}`,\n      [userId]\n    );\n\n    res.json(result.rows);\n  } catch (error) {\n    console.error(\"Error al obtener historial:\", error);\n    res.status(500).json({ error: \"Error al obtener historial\" });\n  }\n};\n\n/**\n * Eliminar simulación\n */\nexports.eliminarSimulacion = async (req, res) => {\n  try {\n    const { id } = req.params;\n    const userId = req.user.id;\n    await pool.query(\"DELETE FROM simulaciones WHERE id = $1 AND user_id = $2\", [id, userId]);\n    res.json({ message: \"Simulación eliminada\" });\n  } catch (error) {\n    console.error(\"Error al eliminar simulación:\", error);\n    res.status(500).json({ error: \"Error al eliminar simulación\" });\n  }\n};\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}